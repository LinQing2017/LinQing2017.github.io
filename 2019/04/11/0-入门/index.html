<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Solr 学习笔记 | LQing的博客 | “做程序员太辛苦了, 我想换行，我该怎么办?” “敲一下回车。”</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Solr">
    <meta name="description" content="Solr的学习笔记">
<meta name="keywords" content="Solr">
<meta property="og:type" content="article">
<meta property="og:title" content="Solr 学习笔记">
<meta property="og:url" content="https:&#x2F;&#x2F;linqing2017.github.io&#x2F;2019&#x2F;04&#x2F;11&#x2F;0-%E5%85%A5%E9%97%A8&#x2F;index.html">
<meta property="og:site_name" content="LQing的博客">
<meta property="og:description" content="Solr的学习笔记">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-06-06T10:43:09.664Z">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" type="application/atom+xml" title="LQing的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">LQing</h5>
          <a href="mailto:m15651620957@163.com" target="_blank" rel="noopener" title="m15651620957@163.com" class="mail">m15651620957@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/LinQing2017" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Solr 学习笔记</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Solr 学习笔记</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-04-10T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2019-04-11
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#安装部署"><span class="post-toc-number">1.</span> <span class="post-toc-text">安装部署</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用脚本安装Standalone模式"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">使用脚本安装Standalone模式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SolrCloud模式"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">SolrCloud模式</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#简单使用"><span class="post-toc-number">2.</span> <span class="post-toc-text">简单使用</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#配置文件"><span class="post-toc-number">3.</span> <span class="post-toc-text">配置文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#configsets"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">configsets</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#schema"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">schema</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SolrCloud"><span class="post-toc-number">4.</span> <span class="post-toc-text">SolrCloud</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#关键概念"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">关键概念</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Replica"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">Replica</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Document-Routing"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Document Routing</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Shard-Splitting"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">Shard Splitting</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Solr-on-HDFS"><span class="post-toc-number">5.</span> <span class="post-toc-text">Solr on HDFS</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参数配置"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">参数配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#缓存机制"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">缓存机制</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#使用SolrCtl命令"><span class="post-toc-number">6.</span> <span class="post-toc-text">使用SolrCtl命令</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#参考文档"><span class="post-toc-number">7.</span> <span class="post-toc-text">参考文档</span></a></li></ol>
        </nav>
    </aside>


<article id="post-0-入门"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Solr 学习笔记</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-04-11 00:00:00" datetime="2019-04-10T16:00:00.000Z"  itemprop="datePublished">2019-04-11</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>Solr的学习笔记 </p>
<a id="more"></a>


<h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><h2 id="使用脚本安装Standalone模式"><a href="#使用脚本安装Standalone模式" class="headerlink" title="使用脚本安装Standalone模式"></a>使用脚本安装Standalone模式</h2><p>Solr安装包的bin目录下提供了install_solr_service.sh脚本，通过该脚本能够在节点上安装Solr服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./install_solr_service.sh solr-7.7.1.tgz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   1. 脚本将solr-7.7.1.tgz，默认解压到/opt目录，并且创建软连接/opt/solr。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   2. 使用/var/solr作为solr的数据目录，该目录下包括solr数据、日志。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   3. 安装完成后使用 /etc/init.d/solr 启停solr服务，该脚本使用solr用户启动服务（或者用service，使用systemctl似乎有一点问题）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   4. 默认使用8983作为Solr的端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   5. 默认情况下solr配置文件为 /etc/default/solr-demo.in.sh ，该文件中包含ZK、Hadoop等信息的定义。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   6. /var/solr/data是默认情况下的主目录，该目录下包含：zoo.cfg和solr.xml。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   7. /opt/solr/bin/oom_solr.sh 该脚本用来杀死oom状态的Solr进程。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   8. solr的安装信息都固化在/etc/init.d/solr中，通过这个文件可以修改配置文件位置信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################################</span></span></span><br></pre></td></tr></table></figure>
<h2 id="SolrCloud模式"><a href="#SolrCloud模式" class="headerlink" title="SolrCloud模式"></a>SolrCloud模式</h2><p>当在/etc/default/solr-demo.in.sh 中配置 ZK_HOST 时，Solr通过Cloud的模式启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用以下命令，可以打开一个交互式的shell，可以根据引导创建一个SolrCloud集群,所有Solr实例运行在一个物理机上</span></span><br><span class="line">bin/solr -e cloud</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面的链接详细说明了如何使用solr命令创建一个solrcloud集群</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># https://lucene.apache.org/solr/guide/7_0/getting-started-with-solrcloud.html#getting-started-with-solrcloud</span></span></span><br></pre></td></tr></table></figure>

<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><p>官方Quick Start展示了使用预置techproducts的一些简单用法：</p>
<p>Exercise 1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bin/post -c techproducts example/exampledocs/* # 使用post命令导入数据</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 搜索任意Document</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?indent=on&amp;q=*:*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个短语搜索</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=foundation</span><br><span class="line"><span class="meta">#</span><span class="bash"> 只返回id字段</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=foundation&amp;fl=id</span><br><span class="line"><span class="meta">#</span><span class="bash"> 搜索指定字段</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=cat:electronics</span><br><span class="line"><span class="meta">#</span><span class="bash"> 搜索短语，这里+被转义为空格</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=\"CAS+latency\"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 联合搜索，%2B是+的转义，%20是空格的转义，等价于+electronics +music</span></span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=%2Belectronics%20%2Bmusic</span><br><span class="line">http://localhost:8983/solr/techproducts/select?q=%2Belectronics+-music</span><br></pre></td></tr></table></figure>

<p>Exercise 2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新collection，使用_default配置</span></span><br><span class="line">bin/solr create -c films -s 2 -rf 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   1. _default生成的是“managed schema”，用户需要使用 Schema API 修改schema的规则。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   2. _default默认是schemaless（这个配置定义在solrconfig.xml中）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   3. 通常情况下不应该在生产环境中使用schemaless特性，而应该手工定义schema.xml文件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   4. </span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建text_general类型的字段，stored为<span class="literal">true</span>表示这个字段可以用来进行查询</span></span><br><span class="line"></span><br><span class="line">curl -X POST -H 'Content-type:application/json' --data-binary '&#123;"add-field": &#123;"name":"name", "type":"text_general", "multiValued":false, "stored":true&#125;&#125;' http://172.24.26.93:8983/solr/films/schema</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CopyField：solr 有一个字段复制机制，可以将多个不同类型字段集中到一个字段。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   </span></span><br><span class="line"><span class="meta">#</span><span class="bash">    典型应用场景：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       用户创建博客索引时，需要查询title、content。 此时可以定义一个新字段，将title和content复制到这个新字段，索引的时候，直接从这个新字段查<span class="comment">#    询，这样就达到目地了。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义一个copyField，将所有字段的值复制到_text_字段</span></span><br><span class="line">curl -X POST -H 'Content-type:application/json' --data-binary '&#123;"add-copy-field" : &#123;"source":"*","dest":"_text_"&#125;&#125;' http://172.24.26.93:8983/solr/films/schema</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用Post命令进行不同格式的数据导入</span></span><br><span class="line"></span><br><span class="line">bin/post -c films example/films/films.csv -params "f.genre.split=true&amp;f.directed_by.split=true&amp;f.genre.separator=|&amp;f.directed_by.separator=|"</span><br><span class="line">bin/post -c films example/films/films.xml</span><br><span class="line">bin/post -c films example/films/films.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Faceting：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        允许将搜索结果排列成子集，为每个子集提供计数。Solr提供以下类型的Faceting：</span></span><br><span class="line">            Field Facets：对某个Field进行分类统计</span><br><span class="line">            Numeric Range Facets：统计某个Field的Range，如价格区间</span><br><span class="line">            Pivot Facets：组合分类，如统计属于A、同时又属于B的记录</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下命令对genre_str进行分类统计，并返回统计结果</span></span><br><span class="line">curl "http://localhost:8983/solr/films/select?q=*:*&amp;rows=0&amp;facet=true&amp;facet.field=genre_str"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下命令对genre_str进行分类统计，但是只返回统计计数大于200的结果</span></span><br><span class="line">curl "http://localhost:8983/solr/films/select?=&amp;q=*:*&amp;facet.field=genre_str&amp;facet.mincount=200&amp;facet=on&amp;rows=0"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计发行年代，范围是[NOW-20YEAR,NOW],每一类的间隔是1年</span></span><br><span class="line">curl 'http://localhost:8983/solr/films/select?q=*:*&amp;rows=0&amp;facet=true&amp;facet.range=initial_release_date&amp;facet.range.start=NOW-20YEAR&amp;facet.range.end=NOW&amp;facet.range.gap=%2B1YEAR'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计类型和导演</span></span><br><span class="line">curl "http://localhost:8983/solr/films/select?q=*:*&amp;rows=0&amp;facet=on&amp;facet.pivot=genre_str,directed_by_str"</span><br></pre></td></tr></table></figure>
<p>Exercise 3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除数据</span></span><br><span class="line">bin/post -c localDocs -d "&lt;delete&gt;&lt;id&gt;SP2514N&lt;/id&gt;&lt;/delete&gt;"</span><br><span class="line">bin/post -c localDocs -d "&lt;delete&gt;&lt;query&gt;*:*&lt;/query&gt;&lt;/delete&gt;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启服务</span></span><br><span class="line">./bin/solr start -c -p 8983 -s example/cloud/node1/solr</span><br><span class="line">./bin/solr start -c -p 7574 -s example/cloud/node2/solr -z localhost:9983</span><br></pre></td></tr></table></figure>


<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>Standlone模式下比较关键的配置文件均在solr.home目录下（可以是/var/solr/data目录）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── films                     # Core 名称目录</span><br><span class="line">│   ├── conf                  ##### SolrCloud模式时放到ZK的configs目录上</span><br><span class="line">│   │   ├── managed-schema    # 该文件是Schema的配置文件</span><br><span class="line">│   │   └── solrconfig.xml    # 这个配置文件指定了core的一些高级配置，如数据目录等等</span><br><span class="line">│   ├── core.properties       # Core的关键信息配置文件</span><br><span class="line">│   └── data</span><br><span class="line">├── solr.xml                  # 单个Solr server信息的配置  ##### SolrCloud模式时放到ZK的configs目录上</span><br><span class="line">└── zoo.cfg</span><br></pre></td></tr></table></figure>
<p>配置文件详细信息参考：</p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/solr-cores-and-solr-xml.html#solr-cores-and-solr-xml" target="_blank" rel="noopener">solr.xml</a><br><a href="https://lucene.apache.org/solr/guide/7_0/defining-core-properties.html#defining-core-properties" target="_blank" rel="noopener">core.properties</a><br><a href="https://lucene.apache.org/solr/guide/7_0/configuring-solrconfig-xml.html#configuring-solrconfig-xml" target="_blank" rel="noopener">solrconfig.xml</a><br><a href="https://lucene.apache.org/solr/guide/7_0/documents-fields-and-schema-design.html" target="_blank" rel="noopener">managed-schema</a></p>
<p>使用CDH部署时，采用的是SolrCloud + HDFS的部署方式，默认情况下使用/metadata/solr/server作为部署目录。</p>
<p>此时安装目录为/opt/cloudera/parcels/CDH/lib/solr！！</p>
<p>使用SolrCloud时，config目录下的配置会在创建Collection时被上传到地址为/solr/configs/{collection name}的Znode中。</p>
<h2 id="configsets"><a href="#configsets" class="headerlink" title="configsets"></a>configsets</h2><p>configsets 实际上是一组可以重用的配置文件模板，configsets中的内容实际上是/var/solr/data/xxx/conf里的内容。</p>
<p>默认情况下configsets在/opt/solr/server/solr/configsets目录中。CDH中这些配置文件似乎是在ZK上？？</p>
<h2 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h2><p>Solr的schema是一个单独的xml文件(managed-schema )，它存储以下信息：</p>
<ul>
<li>core和collection的字段和字段类型信息。</li>
<li>core和collection的查询、存储规则，以及copy fields、dynamic fields的生成规则。</li>
</ul>
<h1 id="SolrCloud"><a href="#SolrCloud" class="headerlink" title="SolrCloud"></a>SolrCloud</h1><h2 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h2><p>群集可以托管多个Solr Collection。可以将Collection划分为多个Shards，每个Shards包含Collection的一部分内容。Shards的数量对Collection来说是确定的，是一种抽象概念。多个Shard可以让搜索请求并行执行。哪个Shard包含集合中的哪些文档取决于该Collection指定的分片策略。</p>
<p>replica是和Shard相对的物理概念，每个shard至少包含一个replica，并且其中一个Replicas是leader（通过ZK的选举机制获得）。</p>
<h2 id="Replica"><a href="#Replica" class="headerlink" title="Replica"></a>Replica</h2><p>由于Replica中需要进行leader，通常情况下Solr支持以下几种Replica类型：</p>
<ul>
<li>NRT：NRT副本（NRT = NearRealTime）维护一个transaction日志并在本地将新文档写入其索引。NRT类型的Replica随时都有资格被选为Leader</li>
<li>TLOG： 此类Replica也维护事务日志，但不会更改本地的本地索引文档（不会更改索引）。TLOG类型的Replica通过从领导者复制索引来实现Index更新。TLOG同样可以成为Leader，并且在成为Leader后，他的行为和NRT类型的副本一致。</li>
<li>PULL：不维护事务日志，也不更改本地索引文档。无法成为leader，也无法参与Leader选举。</li>
</ul>
<p>几种Replica配置方式：</p>
<ul>
<li>All NRT replicas：适合小型集群，或者更新频率不高的大型集群；</li>
<li>All TLOG Replicas： 每个分片的副本数量很高时;</li>
<li>TLOG replicas plus PULL replicas: 每个分片的副本数量很高时，增加查询请求的吞吐量；</li>
</ul>
<h2 id="Document-Routing"><a href="#Document-Routing" class="headerlink" title="Document Routing"></a>Document Routing</h2><p>通过API创建Collection时，可以使用router.name来自动Document使用的路由策略。</p>
<ul>
<li>compositeId ：通过文档ID部分前缀的hash值，进行路由。通常可以使用”!”在文档ID中分割出这一部分前缀，在查询时可以使用_route_来指定需要查询的Shard地址。compositeId方案支持二级路由，如以下类型的ID：”USA!IBM!12345”。同时还支持shard_key/num!document_id格式的路由。</li>
<li>implicit：使用router.field指定的字段来标识所属的shard</li>
</ul>
<h2 id="Shard-Splitting"><a href="#Shard-Splitting" class="headerlink" title="Shard Splitting"></a>Shard Splitting</h2><p>Shard支持Splitting命令，用户可以通过<a href="https://lucene.apache.org/solr/guide/7_0/collections-api.html#splitshard" target="_blank" rel="noopener">SPLITSHARD command</a>将Shard一分为二。</p>
<h1 id="Solr-on-HDFS"><a href="#Solr-on-HDFS" class="headerlink" title="Solr on HDFS"></a>Solr on HDFS</h1><p>Solr支持将索引和事务日志文件写入到HDFS中。通过JVM参数、solr.in.sh、solrconfig.xml三种方式可以指定Solr存储位置。</p>
<h2 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h2><p>Standalone指定以下参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin/solr start -Dsolr.directoryFactory=HdfsDirectoryFactory</span><br><span class="line">     -Dsolr.lock.type=hdfs</span><br><span class="line">     -Dsolr.data.dir=hdfs://host:port/path</span><br><span class="line">     -Dsolr.updatelog=hdfs://host:port/path</span><br></pre></td></tr></table></figure>

<p>SolrCloud 指定以下参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/solr start -c -Dsolr.directoryFactory=HdfsDirectoryFactory</span><br><span class="line">     -Dsolr.lock.type=hdfs</span><br><span class="line">     -Dsolr.hdfs.home=hdfs://host:port/path</span><br></pre></td></tr></table></figure>

<p>使用Apache Solr时对接HDFS需要指定的参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.directoryFactory=HdfsDirectoryFactory"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.lock.type=hdfs"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.home=hdfs://nameservice1/test_solr"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.confdir=/etc/hadoop/conf"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.confdir=/etc/hadoop/conf"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.security.kerberos.enabled=true"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.security.kerberos.keytabfile=/opt/solr/solr.keytab"</span><br><span class="line">SOLR_OPTS="$SOLR_OPTS -Dsolr.hdfs.security.kerberos.principal=solr/lqing93@IDATA.RUIJIE.COM"</span><br></pre></td></tr></table></figure>

<h2 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h2><p>HdfsDirectoryFactory 会申请对外内存用来缓存HDFS上的块信息。此缓存通常需要非常大，可能需要提高运行Solr的特定JVM的堆外内存限制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 以下参数限制JVM的堆外内存大小</span></span><br><span class="line">-XX:MaxDirectMemorySize=20g</span><br></pre></td></tr></table></figure>

<h1 id="使用SolrCtl命令"><a href="#使用SolrCtl命令" class="headerlink" title="使用SolrCtl命令"></a>使用SolrCtl命令</h1><p>solrctl命令是cloudera包装过的solr命令行工具，使用方式和原生solr不同。官方使用说明可以参考<a href="https://hadoop.rcc.uchicago.edu:7183/static/help/topics/search_solrctl_ref.html" target="_blank" rel="noopener">链接</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在/var/lib/solr/demo目录创建配置文件模板</span></span><br><span class="line">solrctl instancedir --generate /var/lib/solr/demo  -schemaless</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传本地目录中的配置文件到ZK，此时生成了一个新的configset</span></span><br><span class="line">solrctl instancedir --create demo /var/lib/solr/demo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建collection，并且使用同名configset</span></span><br><span class="line">solrctl collection --create demo -s 2 -a -c demo -r 2 -m 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑/var/lib/solr/demo目录下的文件后更新到Zookeeper</span></span><br><span class="line">solrctl instancedir --update demo /var/lib/solr/demo</span><br><span class="line"><span class="meta">#</span><span class="bash"> reload collection应用更新后的配置</span></span><br><span class="line">solrctl collection --reload demo</span><br></pre></td></tr></table></figure>

<p>配置kerberos时参考以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> step1</span></span><br><span class="line">solrctl instancedir --generate /var/lib/solr/film  -schemaless</span><br><span class="line"><span class="meta">#</span><span class="bash"> step2</span></span><br><span class="line">kinit -k solr</span><br><span class="line">solrctl --jaas  /etc/zookeeper/conf/jaas.conf --debug --zk bdnode1:2181,bdnode2:2181,bdnode3:2181/solr  instancedir --create film /var/lib/solr/film</span><br><span class="line"><span class="meta">#</span><span class="bash"> step3</span></span><br><span class="line">solrctl collection --create film -s 2 -a -c film -r 2 -m 4</span><br></pre></td></tr></table></figure>

<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.w3cschool.cn/solr_doc/solr_doc-t3642fkr.html" target="_blank" rel="noopener">W3Cschool:Apache Solr参考指南</a></p>
<p><a href="http://lucene.apache.org/solr/guide/7_7/solr-tutorial.html" target="_blank" rel="noopener">官网 QuickStart</a></p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/solr-control-script-reference.html#solr-control-script-reference" target="_blank" rel="noopener">solr命令的使用</a></p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/solrcloud.html#solrcloud" target="_blank" rel="noopener">SolrCloud</a></p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/solrcloud-configuration-and-parameters.html#solrcloud-configuration-and-parameters" target="_blank" rel="noopener">SolrCloud Configuration and Parameters</a> </p>
<p><a href="http://lucene.apache.org/solr/guide/7_7/running-solr-on-hdfs.html#hdfsdirectoryfactory-parameters" target="_blank" rel="noopener">HdfsDirectoryFactory 的配置参数</a></p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/distributed-requests.html#limiting-which-shards-are-queried" target="_blank" rel="noopener">如何在查询时指定分片</a></p>
<p><a href="https://lucene.apache.org/solr/guide/7_0/solrcloud-configuration-and-parameters.html#solrcloud-configuration-and-parameters" target="_blank" rel="noopener">solrcloud-configuration-and-parameters</a></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-06-06T10:43:09.664Z" itemprop="dateUpdated">2020-06-06 18:43:09</time>
</span><br>


        
        原文地址 ：<a href="/2019/04/11/0-%E5%85%A5%E9%97%A8/" target="_blank" rel="external">https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/</a>
        
    </div>
    
    <footer>
        <a href="https://LinQing2017.github.io">
            <img src="/img/avatar.jpg" alt="LQing">
            LQing
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solr/" rel="tag">Solr</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&title=《Solr 学习笔记》 — LQing的博客&pic=https://LinQing2017.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&title=《Solr 学习笔记》 — LQing的博客&source=Solr的学习笔记 " data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Solr 学习笔记》 — LQing的博客&url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&via=https://LinQing2017.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/04/16/1-%E8%AE%A4%E8%AF%81/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Solr 认证配置</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/04/08/9-hbase%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">HBase Tools</h4>
      </a>
    </div>
  
</nav>



    

</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>LQing &copy; 2015 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&title=《Solr 学习笔记》 — LQing的博客&pic=https://LinQing2017.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&title=《Solr 学习笔记》 — LQing的博客&source=Solr的学习笔记 " data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Solr 学习笔记》 — LQing的博客&url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/&via=https://LinQing2017.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://linqing2017.github.io/2019/04/11/0-%E5%85%A5%E9%97%A8/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3a22oDMQwFwP7/T6evhbDbI8kJ2Dt+Crl4PS0IydLPT7xeb+v9/atv/v30auer3RYvDAyMbRmv25Uw7g+RkPLnXu6DgYHxAEYSClcF5fxZydkwMDAwEkYvWbwP0BgYGBgTRvLgPBHMU08MDAyMpIidpIzJ6y/V4hgYGBsy8lv377/+SH8DAwNjK8aruKpBcPKdwqkwMDCOZvQu/ZNyNEn+5ukmBgbGMxmTY/WGvfJxjXL2ioGBcQRjVZKXNDgnCeI/YAwMjKMZ1TLyPggmh0uCfm+YDAMD42xGtRmQj1lUA3GedBYamRgYGJszqiVocsTJlVwVHN0FYmBgbM7oFZn5O0lgnVy0RRkuBgbG0YwkdVvVJMh/u+y6DQMDYxNGL73LGwPVFPN+z8s/FgYGxtGMVe3GeRtgwcwIBgbGoYwkwE3aAPPQHH0HAwPjaMaqsJsH4nnTFAMD42mMPID2GpPVYjhhXw5bYGBgHMqohra8Jp5U1c2kEAMD4wGM6shXlZSUwb0dMDAwnsbIC9pqEVtNMctNUwwMjMcwJilgNaWbPLF5R4iBgbEh41Vc+dHzHfKUsfx/wMDAOIKxalxs3gaolqzVMI2BgbE7o1k0FsG95mhy8YeBgfEcRvM6vjX49ZGyGQMDA6M4JDEP3+VfYWBgYMTbVVO9vNCNilgMDIyjGfOr/GrYzZPOxddtGBgYGzKqIw55gF41bNEL/RgYGEcwfgHtpsdlKvr06wAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>








<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'LQing的博客';
            clearTimeout(titleTime);
        } else {
            document.title = 'LQing的博客';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
